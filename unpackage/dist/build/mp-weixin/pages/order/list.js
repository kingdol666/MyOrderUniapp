"use strict";const e=require("../../common/vendor.js"),t=require("../../api/index.js"),r=require("../../store/index.js"),a={setup(){const a=e.reactive([{name:"全部",value:"all"},{name:"待付款",value:"pending"},{name:"已付款",value:"paid"},{name:"已完成",value:"completed"}]),o=e.ref("all"),s=e.ref([]),n=e.ref(!1),i=e.ref("more"),u=e.ref(0),d=e.ref(!0),c=()=>!!r.store.getUserId()||(e.index.showModal({title:"提示",content:"请先登录后查看订单",confirmText:"去登录",cancelText:"返回",success:t=>{t.confirm?e.index.switchTab({url:"/pages/user/user"}):e.index.navigateBack()}}),!1),l=async(a=!1)=>{if(c())try{if(a&&(u.value=0,s.value=[]),!d.value&&!a)return;i.value="loading";const e=await t.orderApi.getUserOrders({userId:r.store.getUserId(),page:u.value,size:10,status:o.value});e&&e.content&&(s.value=a?e.content:[...s.value,...e.content],d.value=!e.last,i.value=d.value?"more":"noMore",d.value&&u.value++)}catch(n){console.error("加载订单失败:",n),i.value="more",e.index.showToast({title:"加载失败",icon:"none"})}},m=async()=>{c()?(n.value=!0,await l(!0),n.value=!1):n.value=!1};e.onMounted((()=>{c()&&l()}));return{statusTabs:a,currentStatus:o,orderList:s,isRefreshing:n,loadMoreStatus:i,switchStatus:e=>{c()&&(o.value=e,l(!0))},onRefresh:m,loadMore:()=>{"loading"!==i.value&&d.value&&l()},formatTime:e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},getStatusText:e=>({PENDING:"待付款",PROCESSING:"进行中",COMPLETED:"已完成",CANCELLED:"已取消"}[e]||e),getStatusColor:e=>({pending:"#ff9800",processing:"#007AFF",completed:"#52c41a"}[e]||"#999"),getTotalQuantity:e=>e.reduce(((e,t)=>e+t.quantity),0),payOrder:t=>{c()&&e.index.navigateTo({url:`/pages/checkout/checkout?orderId=${t.id}&orderNumber=${t.orderNumber}&amount=${t.totalAmount}`})},cancelOrder:async r=>{try{await t.orderApi.cancelOrder(r.id),e.index.showToast({title:"订单已取消",icon:"success"}),l()}catch(a){console.error("取消订单失败:",a),e.index.showToast({title:"取消失败",icon:"none"})}},buyAgain:async t=>{try{for(const e of t.orderItems)await cartApi.saveCartItem({userId:r.store.getUserId(),menuItemId:e.id,quantity:e.quantity});e.index.showToast({title:"已添加到购物车",icon:"success"}),e.index.switchTab({url:"/pages/cart/cart"})}catch(a){console.error("添加到购物车失败:",a),e.index.showToast({title:"操作失败",icon:"none"})}},deleteOrder:r=>{e.index.showModal({title:"提示",content:"确定要删除该订单吗？",success:async a=>{if(a.confirm)try{await t.orderApi.deleteOrder(r.id),e.index.showToast({title:"删除成功",icon:"success"}),m()}catch(o){console.error("删除订单失败:",o),e.index.showToast({title:"删除失败",icon:"none"})}}})},loadOrders:l,goToOrderDetail:t=>{c()&&e.index.navigateTo({url:`/pages/order/detail?id=${t}`})}}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-load-more"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js"))();const o=e._export_sfc(a,[["render",function(t,r,a,o,s,n){return e.e({a:e.f(o.statusTabs,((t,r,a)=>({a:e.t(t.name),b:t.value,c:o.currentStatus===t.value?1:"",d:e.o((e=>o.switchStatus(t.value)),t.value)}))),b:o.orderList.length>0},o.orderList.length>0?{c:e.f(o.orderList,((t,r,a)=>e.e({a:e.t(t.orderNumber),b:e.t(o.getStatusText(t.status)),c:e.f(t.orderItems,((t,r,a)=>({a:e.t(t.itemName),b:e.t(t.quantity),c:e.t(t.price.toFixed(2)),d:t.id}))),d:e.t(o.formatTime(t.createTime)),e:e.t(t.totalAmount.toFixed(2)),f:"PENDING"===t.status},"PENDING"===t.status?{g:e.o((e=>o.payOrder(t)),t.id),h:e.o((e=>o.cancelOrder(t)),t.id)}:"COMPLETED"===t.status?{j:e.o((e=>o.deleteOrder(t)),t.id),k:e.o((e=>o.buyAgain(t)),t.id)}:(t.status,{}),{i:"COMPLETED"===t.status,l:"PAID"===t.status,m:t.id})))}:{d:e.p({type:"shop",size:"50",color:"#999"})},{e:e.p({status:o.loadMoreStatus}),f:o.isRefreshing,g:e.o(((...e)=>o.onRefresh&&o.onRefresh(...e))),h:e.o(((...e)=>o.loadMore&&o.loadMore(...e)))})}],["__scopeId","data-v-bb7444c8"]]);wx.createPage(o);
