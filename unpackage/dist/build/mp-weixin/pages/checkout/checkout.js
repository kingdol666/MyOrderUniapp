"use strict";const e=require("../../common/vendor.js"),t=require("../../api/index.js"),i=require("../../store/index.js"),r={data:()=>({order:null,orderItems:[],loading:!1,isPaying:!1,userId:""}),onLoad(e){this.userId=i.store.getUserId();const t=e.orderId;console.log(t),t?this.loadOrderById(t):this.loadLatestOrder()},methods:{async loadOrderById(i){try{this.loading=!0;const e=await t.orderApi.getOrderDetails(i);this.order=e,this.orderItems=e.orderItems||[],console.log(this.order)}catch(r){console.error("加载订单详情失败:",r),e.index.showToast({title:"加载订单失败",icon:"none"})}finally{this.loading=!1}},async loadLatestOrder(){try{this.loading=!0;const r=i.store.getUserId(),o=await t.orderApi.getUserOrders(r,0,1);if(o&&o.content&&o.content.length>0){const e=o.content[0];await this.loadOrderById(e.id)}else e.index.showToast({title:"没有找到订单",icon:"none"}),setTimeout((()=>{e.index.navigateBack()}),1500)}catch(r){console.error("加载最新订单失败:",r),e.index.showToast({title:"加载订单失败",icon:"none"})}finally{this.loading=!1}},async handlePay(){if(!this.isPaying){this.isPaying=!0;try{const i=await t.orderApi.getWxPayParams(this.order.id);await new Promise(((t,r)=>{e.index.requestPayment({...i,success:e=>{t(e)},fail:e=>{r(e)}})})),await t.orderApi.payOrder(this.order.id),e.index.showToast({title:"支付成功",icon:"success"}),await cartApi.clearCart(this.userId),setTimeout((()=>{e.index.redirectTo({url:"/pages/menu/menu"})}),1500)}catch(i){console.error("支付失败:",i),e.index.showToast({title:i.message||"支付失败",icon:"none"})}finally{this.isPaying=!1}}}}};const o=e._export_sfc(r,[["render",function(t,i,r,o,s,a){return{a:e.f(s.orderItems,((t,i,r)=>({a:e.t(t.itemName),b:e.t(t.quantity),c:e.t((t.price*t.quantity).toFixed(2)),d:t.id}))),b:e.t(s.order.totalAmount.toFixed(2)),c:e.t(s.isPaying?"支付中...":"立即支付"),d:e.o(((...e)=>a.handlePay&&a.handlePay(...e))),e:s.isPaying}}],["__scopeId","data-v-82429808"]]);wx.createPage(o);
