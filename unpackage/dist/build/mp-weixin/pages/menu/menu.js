"use strict";const e=require("../../common/vendor.js"),t=require("../../api/index.js"),o=require("../../store/index.js"),r={data:()=>({searchKeyword:"",currentCategoryId:o.store.getCurrentCategoryId(),categories:[],menuItems:[],isRefreshing:!1,loadMoreStatus:"more",page:1,loading:!1}),async onShow(){await this.loadCategories(),await this.loadMenuItems(),console.log("当前分类ID:",this.currentCategoryId);const e=o.store.getCurrentCategoryId();null!==e?await this.selectCategory(e):await this.selectCategory(this.categories[0].id)},methods:{async handleSearch(t){this.searchKeyword.trim()?e.index.navigateTo({url:`/pages/menu/detail?keyword=${encodeURIComponent(this.searchKeyword.trim())}`}):e.index.showToast({title:"请输入搜索关键词",icon:"none"})},async loadCategories(){try{const e=await t.categoryApi.getAllCategories();this.categories=e}catch(o){console.error("加载分类失败:",o),e.index.showToast({title:"加载分类失败",icon:"none"})}},async selectCategory(e){try{if(!e)return void console.warn("selectCategory: categoryId is missing.");if(this.currentCategoryId===e)return console.log("选中的分类相同，刷新菜单:",e),void(await this.loadMenuItems());this.currentCategoryId=e,o.store.setCurrentCategoryId(e),console.log("切换到新分类:",e),await this.loadMenuItems()}catch(t){console.error("selectCategory encountered an error:",t)}},async loadMenuItems(){try{this.loading=!0;null===o.store.getCurrentCategoryId()&&await this.selectCategory(this.categories[0].id);const e=await t.menuApi.getMenuItemsByCategory(this.currentCategoryId);this.menuItems=e}catch(r){"request:fail abort"!==r.errMsg&&(console.error("加载菜品失败:",r),e.index.showToast({title:"加载菜品失败",icon:"none"}))}finally{this.loading=!1}},async onRefresh(){this.isRefreshing=!0,await this.loadCategories(),await this.loadMenuItems(),this.isRefreshing=!1,e.index.stopPullDownRefresh()},async addToCart(r){try{const a=o.store.getUserId();if(!a)return void e.index.showModal({title:"提示",content:"请先登录后再操作",confirmText:"去登录",success:t=>{t.confirm&&e.index.switchTab({url:"/pages/user/user"})}});await t.cartApi.saveCartItem({userId:a,menuItemId:r.id,quantity:1}),e.index.showToast({title:"已加入购物车",icon:"success"}),await o.store.updateCartBadge()}catch(a){console.error("添加到购物车失败:",a),e.index.showToast({title:"添加失败",icon:"none"})}},handleImageError(e){console.error("图片加载失败:",e),e.target.src="/static/default-food.png"},async updateCartCount(){const e=this.$store.getUserId();if(e)try{const o=await t.cartApi.getCartItems(e);this.cartItemCount=o.reduce(((e,t)=>e+t.quantity),0)}catch(o){console.error("获取购物车失败:",o)}},navigateToDetail(t){e.index.navigateTo({url:`/pages/menu/detail?id=${t.id}`})},loadMore(){"noMore"!==this.loadMoreStatus&&(this.loadMoreStatus="loading",setTimeout((()=>{this.loadMoreStatus="noMore"}),1e3))},refreshList(){this.page=1},hotSearchTags:e.ref(["热销套餐","今日特价","新品上市","店长推荐"]),quickSearch(e){this.searchKeyword=e,this.handleSearch()}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-search-bar")+e.resolveComponent("uni-tag")+e.resolveComponent("uni-load-more"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-search-bar/components/uni-search-bar/uni-search-bar.js")+(()=>"../../uni_modules/uni-tag/components/uni-tag/uni-tag.js")+(()=>"../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js"))();const a=e._export_sfc(r,[["render",function(t,o,r,a,s,i){return{a:e.p({color:"#666",size:"18",type:"search"}),b:e.o(i.handleSearch),c:e.o((e=>s.searchKeyword=e)),d:e.p({radius:"100",placeholder:"探索美食...",bgColor:"#f5f6f7",cancelButton:"none",modelValue:s.searchKeyword}),e:e.f(i.hotSearchTags,((t,o,r)=>({a:e.t(t),b:o,c:e.o((e=>i.quickSearch(t)),o)}))),f:e.f(s.categories,((t,o,r)=>e.e({a:e.t(t.name),b:s.currentCategoryId===t.id},(s.currentCategoryId,t.id,{}),{c:t.id,d:s.currentCategoryId===t.id?1:"",e:e.o((e=>i.selectCategory(t.id)),t.id)}))),g:e.f(s.menuItems,((t,o,r)=>e.e({a:t.imageUrl||"/static/default-food.png",b:e.o(((...e)=>i.handleImageError&&i.handleImageError(...e)),t.id),c:t.isRecommend},t.isRecommend?{d:"d8128fd0-2-"+r,e:e.p({text:"推荐",type:"warning",size:"small",customStyle:"background: linear-gradient(135deg, #ff6b6b, #ff8787)"})}:{},{f:e.t(t.name),g:e.t(t.description),h:e.t(t.price),i:e.t(t.salesCount),j:"d8128fd0-3-"+r,k:e.o((e=>i.addToCart(t)),t.id),l:t.id,m:.05*o+"s",n:e.o((e=>i.navigateToDetail(t)),t.id)}))),h:e.p({type:"plus",size:"24",color:"#fff"}),i:e.p({status:s.loadMoreStatus,iconType:"circle"}),j:s.isRefreshing,k:e.o(((...e)=>i.onRefresh&&i.onRefresh(...e))),l:e.o(((...e)=>i.loadMore&&i.loadMore(...e)))}}],["__scopeId","data-v-d8128fd0"]]);wx.createPage(a);
