"use strict";const e=require("../common/vendor.js"),t=require("../api/index.js"),r={state:{isLoggedIn:!1,currentUser:null,token:e.index.getStorageSync("token")||"",userId:e.index.getStorageSync("userId")||"",userInfo:e.index.getStorageSync("userInfo")||null,currentCategoryId:null},setCurrentCategoryId(e){this.state.currentCategoryId=e},getCurrentCategoryId(){return this.state.currentCategoryId},getUserId(){return this.state.userId||e.index.getStorageSync("userId")},checkLogin(){return this.state.isLoggedIn&&this.state.userId},setUserId(t){this.state.userId=t,e.index.setStorageSync("userId",t)},login(t,r){this.setUserId(t.id),this.state.isLoggedIn=!0,this.state.currentUser=t,this.state.token=r,console.log("用户ID:",t.id),e.index.setStorageSync("token",r),e.index.setStorageSync("userInfo",JSON.stringify(t)),e.index.setStorageSync("userId",t.id)},async logout(){try{await t.userApi.logout()}catch(r){console.error("退出登录失败:",r)}finally{this.state.isLoggedIn=!1,this.state.currentUser=null,this.state.token="",this.state.userId="",e.index.removeStorageSync("token"),e.index.removeStorageSync("userInfo"),e.index.removeStorageSync("userId")}},initUserState(){const t=e.index.getStorageSync("userInfo"),r=e.index.getStorageSync("userId");t&&(this.state.currentUser=JSON.parse(t),this.state.isLoggedIn=!0,this.state.userId=r)},async updateCartBadge(){try{const r=this.getUserId();if(r){const s=(await t.cartApi.getCartItems(r)).reduce(((e,t)=>e+t.quantity),0);s>0?e.index.setTabBarBadge({index:2,text:s.toString()}):e.index.removeTabBarBadge({index:2})}}catch(r){console.error("更新购物车角标失败:",r)}}};exports.store=r;
