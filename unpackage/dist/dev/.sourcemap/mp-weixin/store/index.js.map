{"version":3,"file":"index.js","sources":["store/index.js"],"sourcesContent":["import { userApi, cartApi } from \"@/api\"\r\n\r\nconst store = {\r\n  state: {\r\n    isLoggedIn: false,\r\n    currentUser: null,\r\n    token: uni.getStorageSync('token') || '',\r\n    userId: uni.getStorageSync('userId') || '',\r\n    userInfo: uni.getStorageSync('userInfo') || null,\r\n    currentCategoryId: null,\r\n  },\r\n  \r\n  setCurrentCategoryId(categoryId) {\r\n    this.state.currentCategoryId = categoryId\r\n  },\r\n  getCurrentCategoryId() {\r\n    return this.state.currentCategoryId\r\n  },\r\n\r\n  // 获取用户ID\r\n  getUserId() {\r\n    return this.state.userId || uni.getStorageSync('userId')\r\n  },\r\n  \r\n  // 检查登录状态\r\n  checkLogin() {\r\n    return this.state.isLoggedIn && this.state.userId\r\n  },\r\n  \r\n  setUserId(userId) {\r\n    this.state.userId = userId\r\n    uni.setStorageSync('userId', userId)\r\n  },\r\n  \r\n  login(user, token) {\r\n    this.setUserId(user.id)\r\n    this.state.isLoggedIn = true\r\n    this.state.currentUser = user\r\n    this.state.token = token\r\n    \r\n    console.log('用户ID:', user.id)\r\n    \r\n    // 持久化存储\r\n    uni.setStorageSync('token', token)\r\n    uni.setStorageSync('userInfo', JSON.stringify(user))\r\n    uni.setStorageSync('userId', user.id)\r\n  },\r\n  \r\n  async logout() {\r\n    try {\r\n      // 调用后端退出登录接口\r\n      await userApi.logout()\r\n    } catch (error) {\r\n      console.error('退出登录失败:', error)\r\n    } finally {\r\n      // 清除状态\r\n      this.state.isLoggedIn = false\r\n      this.state.currentUser = null\r\n      this.state.token = ''\r\n      this.state.userId = ''\r\n      \r\n      // 清除存储\r\n      uni.removeStorageSync('token')\r\n      uni.removeStorageSync('userInfo')\r\n      uni.removeStorageSync('userId')\r\n    }\r\n  },\r\n  \r\n  initUserState() {\r\n    const userInfo = uni.getStorageSync('userInfo')\r\n    const userId = uni.getStorageSync('userId')\r\n    if (userInfo) {\r\n      this.state.currentUser = JSON.parse(userInfo)\r\n      this.state.isLoggedIn = true\r\n      this.state.userId = userId\r\n    }\r\n  },\r\n\r\n  async updateCartBadge() {\r\n    try {\r\n      const userId = this.getUserId()\r\n      if (userId) {\r\n        const cartItems = await cartApi.getCartItems(userId)\r\n        const totalCount = cartItems.reduce((sum, item) => sum + item.quantity, 0)\r\n        \r\n        if (totalCount > 0) {\r\n          uni.setTabBarBadge({\r\n            index: 2, // 购物车的 tabBar 索引\r\n            text: totalCount.toString(),\r\n          })\r\n        } else {\r\n          uni.removeTabBarBadge({\r\n            index: 2,\r\n          })\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('更新购物车角标失败:', error)\r\n    }\r\n  },\r\n}\r\n\r\nexport default store "],"names":["uni","userApi","cartApi"],"mappings":";;;AAEK,MAAC,QAAQ;AAAA,EACZ,OAAO;AAAA,IACL,YAAY;AAAA,IACZ,aAAa;AAAA,IACb,OAAOA,cAAG,MAAC,eAAe,OAAO,KAAK;AAAA,IACtC,QAAQA,cAAG,MAAC,eAAe,QAAQ,KAAK;AAAA,IACxC,UAAUA,cAAG,MAAC,eAAe,UAAU,KAAK;AAAA,IAC5C,mBAAmB;AAAA,EACpB;AAAA,EAED,qBAAqB,YAAY;AAC/B,SAAK,MAAM,oBAAoB;AAAA,EAChC;AAAA,EACD,uBAAuB;AACrB,WAAO,KAAK,MAAM;AAAA,EACnB;AAAA;AAAA,EAGD,YAAY;AACV,WAAO,KAAK,MAAM,UAAUA,cAAAA,MAAI,eAAe,QAAQ;AAAA,EACxD;AAAA;AAAA,EAGD,aAAa;AACX,WAAO,KAAK,MAAM,cAAc,KAAK,MAAM;AAAA,EAC5C;AAAA,EAED,UAAU,QAAQ;AAChB,SAAK,MAAM,SAAS;AACpBA,wBAAI,eAAe,UAAU,MAAM;AAAA,EACpC;AAAA,EAED,MAAM,MAAM,OAAO;AACjB,SAAK,UAAU,KAAK,EAAE;AACtB,SAAK,MAAM,aAAa;AACxB,SAAK,MAAM,cAAc;AACzB,SAAK,MAAM,QAAQ;AAEnBA,kBAAA,MAAA,MAAA,OAAA,wBAAY,SAAS,KAAK,EAAE;AAG5BA,wBAAI,eAAe,SAAS,KAAK;AACjCA,kBAAG,MAAC,eAAe,YAAY,KAAK,UAAU,IAAI,CAAC;AACnDA,kBAAAA,MAAI,eAAe,UAAU,KAAK,EAAE;AAAA,EACrC;AAAA,EAED,MAAM,SAAS;AACb,QAAI;AAEF,YAAMC,UAAAA,QAAQ,OAAQ;AAAA,IACvB,SAAQ,OAAO;AACdD,oBAAAA,MAAc,MAAA,SAAA,wBAAA,WAAW,KAAK;AAAA,IACpC,UAAc;AAER,WAAK,MAAM,aAAa;AACxB,WAAK,MAAM,cAAc;AACzB,WAAK,MAAM,QAAQ;AACnB,WAAK,MAAM,SAAS;AAGpBA,oBAAG,MAAC,kBAAkB,OAAO;AAC7BA,oBAAG,MAAC,kBAAkB,UAAU;AAChCA,oBAAG,MAAC,kBAAkB,QAAQ;AAAA,IAC/B;AAAA,EACF;AAAA,EAED,gBAAgB;AACd,UAAM,WAAWA,cAAAA,MAAI,eAAe,UAAU;AAC9C,UAAM,SAASA,cAAAA,MAAI,eAAe,QAAQ;AAC1C,QAAI,UAAU;AACZ,WAAK,MAAM,cAAc,KAAK,MAAM,QAAQ;AAC5C,WAAK,MAAM,aAAa;AACxB,WAAK,MAAM,SAAS;AAAA,IACrB;AAAA,EACF;AAAA,EAED,MAAM,kBAAkB;AACtB,QAAI;AACF,YAAM,SAAS,KAAK,UAAW;AAC/B,UAAI,QAAQ;AACV,cAAM,YAAY,MAAME,kBAAQ,aAAa,MAAM;AACnD,cAAM,aAAa,UAAU,OAAO,CAAC,KAAK,SAAS,MAAM,KAAK,UAAU,CAAC;AAEzE,YAAI,aAAa,GAAG;AAClBF,wBAAAA,MAAI,eAAe;AAAA,YACjB,OAAO;AAAA;AAAA,YACP,MAAM,WAAW,SAAU;AAAA,UACvC,CAAW;AAAA,QACX,OAAe;AACLA,wBAAAA,MAAI,kBAAkB;AAAA,YACpB,OAAO;AAAA,UACnB,CAAW;AAAA,QACF;AAAA,MACF;AAAA,IACF,SAAQ,OAAO;AACdA,oBAAAA,MAAc,MAAA,SAAA,wBAAA,cAAc,KAAK;AAAA,IAClC;AAAA,EACF;AACH;;"}