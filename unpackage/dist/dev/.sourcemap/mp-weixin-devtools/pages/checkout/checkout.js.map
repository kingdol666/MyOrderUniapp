{"version":3,"names":["_sfc_main","data","order","orderItems","loading","isPaying","userId","onLoad","options","store_index","store","getUserId","orderId","common_vendor","index","__f__","loadOrderById","loadLatestOrder","methods","_this","_asyncToGenerator2","_regeneratorRuntime2","mark","_callee","wrap","_callee$","_context","prev","next","api_index","orderApi","getOrderDetails","sent","t0","showToast","title","icon","finish","stop","_this2","_callee2","orders","latestOrder","_callee2$","_context2","getUserOrders","content","length","id","setTimeout","navigateBack","handlePay","_this3","_callee3","payParams","_callee3$","_context3","abrupt","getWxPayParams","Promise","resolve","reject","requestPayment","_objectSpread2","success","res","fail","err","payOrder","cartApi","clearCart","redirectTo","url","message","wx","createPage","MiniProgramPage"],"sources":["checkout.vue","cGFnZXMvY2hlY2tvdXQvY2hlY2tvdXQudnVl"],"sourcesContent":["<template>\r\n  <view class=\"checkout-container\">\r\n    <!-- 订单信息 -->\r\n    <view class=\"order-info\">\r\n      <view class=\"section-title\">订单信息</view>\r\n      <view class=\"order-items\">\r\n        <view v-for=\"item in orderItems\" :key=\"item.id\" class=\"order-item\">\r\n          <text class=\"item-name\">{{ item.itemName }}</text>\r\n          <text class=\"item-quantity\">x{{ item.quantity }}</text>\r\n          <text class=\"item-price\"\r\n            >¥{{ (item.price * item.quantity).toFixed(2) }}</text\r\n          >\r\n        </view>\r\n      </view>\r\n      <view class=\"total-amount\">\r\n        <text>合计：</text>\r\n        <text class=\"price\">¥{{ order.totalAmount.toFixed(2) }}</text>\r\n      </view>\r\n    </view>\r\n\r\n    <!-- 支付按钮 -->\r\n    <view class=\"pay-section\">\r\n      <button class=\"pay-btn\" @click=\"handlePay\" :disabled=\"isPaying\">\r\n        {{ isPaying ? \"支付中...\" : \"立即支付\" }}\r\n      </button>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport { orderApi } from \"@/api\";\r\nimport store from \"@/store\";\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      order: null,\r\n      orderItems: [],\r\n      loading: false,\r\n      isPaying: false,\r\n      userId: \"\",\r\n    };\r\n  },\r\n\r\n  onLoad(options) {\r\n    this.userId = store.getUserId();\r\n    const orderId = options.orderId;\r\n    console.log(orderId);\r\n    if (orderId) {\r\n      this.loadOrderById(orderId);\r\n    } else {\r\n      this.loadLatestOrder();\r\n    }\r\n  },\r\n\r\n  methods: {\r\n    // 根据ID加载订单\r\n    async loadOrderById(orderId) {\r\n      try {\r\n        this.loading = true;\r\n        const order = await orderApi.getOrderDetails(orderId);\r\n        this.order = order;\r\n        this.orderItems = order.orderItems || [];\r\n        console.log(this.order);\r\n      } catch (error) {\r\n        console.error(\"加载订单详情失败:\", error);\r\n        uni.showToast({\r\n          title: \"加载订单失败\",\r\n          icon: \"none\",\r\n        });\r\n      } finally {\r\n        this.loading = false;\r\n      }\r\n    },\r\n\r\n    // 加载最新订单\r\n    async loadLatestOrder() {\r\n      try {\r\n        this.loading = true;\r\n        const userId = store.getUserId();\r\n        const orders = await orderApi.getUserOrders(userId, 0, 1);\r\n        if (orders && orders.content && orders.content.length > 0) {\r\n          const latestOrder = orders.content[0];\r\n          await this.loadOrderById(latestOrder.id);\r\n        } else {\r\n          uni.showToast({\r\n            title: \"没有找到订单\",\r\n            icon: \"none\",\r\n          });\r\n          setTimeout(() => {\r\n            uni.navigateBack();\r\n          }, 1500);\r\n        }\r\n      } catch (error) {\r\n        console.error(\"加载最新订单失败:\", error);\r\n        uni.showToast({\r\n          title: \"加载订单失败\",\r\n          icon: \"none\",\r\n        });\r\n      } finally {\r\n        this.loading = false;\r\n      }\r\n    },\r\n\r\n    async handlePay() {\r\n      if (this.isPaying) return;\r\n\r\n      this.isPaying = true;\r\n      try {\r\n        // 获取支付参数\r\n        const payParams = await orderApi.getWxPayParams(this.order.id);\r\n\r\n        // 调用微信支付\r\n        await new Promise((resolve, reject) => {\r\n          uni.requestPayment({\r\n            ...payParams,\r\n            success: (res) => {\r\n              resolve(res);\r\n            },\r\n            fail: (err) => {\r\n              reject(err);\r\n            },\r\n          });\r\n        });\r\n\r\n        // 支付成功后处理\r\n        await orderApi.payOrder(this.order.id);\r\n\r\n        uni.showToast({\r\n          title: \"支付成功\",\r\n          icon: \"success\",\r\n        });\r\n\r\n        // 清空购物车\r\n        await cartApi.clearCart(this.userId);\r\n\r\n        // 延迟跳转到订单列表\r\n        setTimeout(() => {\r\n          uni.redirectTo({\r\n            url: \"/pages/menu/menu\",\r\n          });\r\n        }, 1500);\r\n      } catch (error) {\r\n        console.error(\"支付失败:\", error);\r\n        uni.showToast({\r\n          title: error.message || \"支付失败\",\r\n          icon: \"none\",\r\n        });\r\n      } finally {\r\n        this.isPaying = false;\r\n      }\r\n    },\r\n  },\r\n};\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.checkout-container {\r\n  min-height: 100vh;\r\n  background-color: #f5f5f5;\r\n  padding: 20rpx;\r\n}\r\n\r\n.order-info {\r\n  background-color: #fff;\r\n  border-radius: 12rpx;\r\n  padding: 20rpx;\r\n  margin-bottom: 20rpx;\r\n\r\n  .section-title {\r\n    font-size: 32rpx;\r\n    font-weight: bold;\r\n    margin-bottom: 20rpx;\r\n  }\r\n\r\n  .order-items {\r\n    .order-item {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      padding: 20rpx 0;\r\n      border-bottom: 1px solid #eee;\r\n\r\n      &:last-child {\r\n        border-bottom: none;\r\n      }\r\n\r\n      .item-name {\r\n        flex: 1;\r\n        font-size: 28rpx;\r\n      }\r\n\r\n      .item-quantity {\r\n        color: #666;\r\n        margin: 0 20rpx;\r\n      }\r\n\r\n      .item-price {\r\n        color: #f56c6c;\r\n        font-weight: bold;\r\n      }\r\n    }\r\n  }\r\n\r\n  .total-amount {\r\n    display: flex;\r\n    justify-content: flex-end;\r\n    align-items: center;\r\n    margin-top: 20rpx;\r\n    padding-top: 20rpx;\r\n    border-top: 1px solid #eee;\r\n\r\n    .price {\r\n      color: #f56c6c;\r\n      font-size: 36rpx;\r\n      font-weight: bold;\r\n      margin-left: 20rpx;\r\n    }\r\n  }\r\n}\r\n\r\n.pay-section {\r\n  position: fixed;\r\n  bottom: 0;\r\n  left: 0;\r\n  right: 0;\r\n  padding: 20rpx;\r\n  background-color: #fff;\r\n  box-shadow: 0 -2rpx 10rpx rgba(0, 0, 0, 0.05);\r\n\r\n  .pay-btn {\r\n    width: 100%;\r\n    height: 88rpx;\r\n    line-height: 88rpx;\r\n    background-color: #07c160;\r\n    color: #fff;\r\n    font-size: 32rpx;\r\n    border-radius: 44rpx;\r\n\r\n    &:active {\r\n      background-color: #06ae56;\r\n    }\r\n\r\n    &[disabled] {\r\n      background-color: #ccc;\r\n    }\r\n  }\r\n}\r\n</style>\r\n","import MiniProgramPage from 'E:/HBuilder/Project/MyOrderTest/pages/checkout/checkout.vue'\nwx.createPage(MiniProgramPage)"],"mappings":";;;;;;;;;AAiCA,IAAKA,SAAA,GAAU;EACbC,IAAA,WAAAA,KAAA,EAAO;IACL,OAAO;MACLC,KAAA,EAAO;MACPC,UAAA,EAAY,EAAE;MACdC,OAAA,EAAS;MACTC,QAAA,EAAU;MACVC,MAAA,EAAQ;IAAA;EAEX;EAEDC,MAAA,WAAAA,OAAOC,OAAA,EAAS;IACd,KAAKF,MAAA,GAASG,WAAA,CAAAC,KAAA,CAAMC,SAAA;IACpB,IAAMC,OAAA,GAAUJ,OAAA,CAAQI,OAAA;IACxBC,aAAA,CAAAC,KAAA,CAAAC,KAAA,6CAAYH,OAAO;IACnB,IAAIA,OAAA,EAAS;MACX,KAAKI,aAAA,CAAcJ,OAAO;IAAA,OACrB;MACL,KAAKK,eAAA,EAAe;IACtB;EACD;EAEDC,OAAA,EAAS;IAAA;IAEDF,aAAA,WAAAA,cAAcJ,OAAA,EAAS;MAAA,IAAAO,KAAA;MAAA,OAAAC,kBAAA,eAAAC,oBAAA,GAAAC,IAAA,UAAAC,QAAA;QAAA,IAAArB,KAAA;QAAA,OAAAmB,oBAAA,GAAAG,IAAA,UAAAC,SAAAC,QAAA;UAAA,kBAAAA,QAAA,CAAAC,IAAA,GAAAD,QAAA,CAAAE,IAAA;YAAA;cAAAF,QAAA,CAAAC,IAAA;cAEzBR,KAAA,CAAKf,OAAA,GAAU;cAAAsB,QAAA,CAAAE,IAAA;cAAA,OACKC,SAAA,CAAAC,QAAA,CAASC,eAAA,CAAgBnB,OAAO;YAAA;cAA9CV,KAAA,GAAAwB,QAAA,CAAAM,IAAA;cACNb,KAAA,CAAKjB,KAAA,GAAQA,KAAA;cACbiB,KAAA,CAAKhB,UAAA,GAAaD,KAAA,CAAMC,UAAA,IAAc;cACtCU,aAAA,CAAAC,KAAA,CAAAC,KAAA,6CAAYI,KAAA,CAAKjB,KAAK;cAAAwB,QAAA,CAAAE,IAAA;cAAA;YAAA;cAAAF,QAAA,CAAAC,IAAA;cAAAD,QAAA,CAAAO,EAAA,GAAAP,QAAA;cAEtBb,aAAA,CAAAC,KAAA,CAAAC,KAAA,+CAAc,aAAAW,QAAA,CAAAO,EAAA,CAAkB;cAChCpB,aAAA,CAAAC,KAAA,CAAIoB,SAAA,CAAU;gBACZC,KAAA,EAAO;gBACPC,IAAA,EAAM;cACR,CAAC;YAAA;cAAAV,QAAA,CAAAC,IAAA;cAEDR,KAAA,CAAKf,OAAA,GAAU;cAAA,OAAAsB,QAAA,CAAAW,MAAA;YAAA;YAAA;cAAA,OAAAX,QAAA,CAAAY,IAAA;UAAA;QAAA,GAAAf,OAAA;MAAA;IAElB;IAAA;IAGKN,eAAA,WAAAA,gBAAA,EAAkB;MAAA,IAAAsB,MAAA;MAAA,OAAAnB,kBAAA,eAAAC,oBAAA,GAAAC,IAAA,UAAAkB,SAAA;QAAA,IAAAlC,MAAA,EAAAmC,MAAA,EAAAC,WAAA;QAAA,OAAArB,oBAAA,GAAAG,IAAA,UAAAmB,UAAAC,SAAA;UAAA,kBAAAA,SAAA,CAAAjB,IAAA,GAAAiB,SAAA,CAAAhB,IAAA;YAAA;cAAAgB,SAAA,CAAAjB,IAAA;cAEpBY,MAAA,CAAKnC,OAAA,GAAU;cACTE,MAAA,GAASG,WAAA,CAAAC,KAAA,CAAMC,SAAA;cAAAiC,SAAA,CAAAhB,IAAA;cAAA,OACAC,SAAA,CAAAC,QAAA,CAASe,aAAA,CAAcvC,MAAA,EAAQ,GAAG,CAAC;YAAA;cAAlDmC,MAAA,GAAAG,SAAA,CAAAZ,IAAA;cAAA,MACFS,MAAA,IAAUA,MAAA,CAAOK,OAAA,IAAWL,MAAA,CAAOK,OAAA,CAAQC,MAAA,GAAS;gBAAAH,SAAA,CAAAhB,IAAA;gBAAA;cAAA;cAChDc,WAAA,GAAcD,MAAA,CAAOK,OAAA,CAAQ,CAAC;cAAAF,SAAA,CAAAhB,IAAA;cAAA,OAC9BW,MAAA,CAAKvB,aAAA,CAAc0B,WAAA,CAAYM,EAAE;YAAA;cAAAJ,SAAA,CAAAhB,IAAA;cAAA;YAAA;cAEvCf,aAAA,CAAAC,KAAA,CAAIoB,SAAA,CAAU;gBACZC,KAAA,EAAO;gBACPC,IAAA,EAAM;cACR,CAAC;cACDa,UAAA,CAAW,YAAM;gBACfpC,aAAA,CAAGC,KAAA,CAACoC,YAAA,EAAY;cACjB,GAAE,IAAI;YAAA;cAAAN,SAAA,CAAAhB,IAAA;cAAA;YAAA;cAAAgB,SAAA,CAAAjB,IAAA;cAAAiB,SAAA,CAAAX,EAAA,GAAAW,SAAA;cAGT/B,aAAA,CAAAC,KAAA,CAAAC,KAAA,+CAAc,aAAA6B,SAAA,CAAAX,EAAA,CAAkB;cAChCpB,aAAA,CAAAC,KAAA,CAAIoB,SAAA,CAAU;gBACZC,KAAA,EAAO;gBACPC,IAAA,EAAM;cACR,CAAC;YAAA;cAAAQ,SAAA,CAAAjB,IAAA;cAEDY,MAAA,CAAKnC,OAAA,GAAU;cAAA,OAAAwC,SAAA,CAAAP,MAAA;YAAA;YAAA;cAAA,OAAAO,SAAA,CAAAN,IAAA;UAAA;QAAA,GAAAE,QAAA;MAAA;IAElB;IAEKW,SAAA,WAAAA,UAAA,EAAY;MAAA,IAAAC,MAAA;MAAA,OAAAhC,kBAAA,eAAAC,oBAAA,GAAAC,IAAA,UAAA+B,SAAA;QAAA,IAAAC,SAAA;QAAA,OAAAjC,oBAAA,GAAAG,IAAA,UAAA+B,UAAAC,SAAA;UAAA,kBAAAA,SAAA,CAAA7B,IAAA,GAAA6B,SAAA,CAAA5B,IAAA;YAAA;cAAA,KACZwB,MAAA,CAAK/C,QAAA;gBAAAmD,SAAA,CAAA5B,IAAA;gBAAA;cAAA;cAAA,OAAA4B,SAAA,CAAAC,MAAA;YAAA;cAETL,MAAA,CAAK/C,QAAA,GAAW;cAAAmD,SAAA,CAAA7B,IAAA;cAAA6B,SAAA,CAAA5B,IAAA;cAAA,OAGUC,SAAA,CAAAC,QAAA,CAAS4B,cAAA,CAAeN,MAAA,CAAKlD,KAAA,CAAM8C,EAAE;YAAA;cAAvDM,SAAA,GAAAE,SAAA,CAAAxB,IAAA;cAAAwB,SAAA,CAAA5B,IAAA;cAAA,OAGA,IAAI+B,OAAA,CAAQ,UAACC,OAAA,EAASC,MAAA,EAAW;gBACrChD,aAAA,CAAAC,KAAA,CAAIgD,cAAA,CAAAC,cAAA,CAAAA,cAAA,KACCT,SAAA;kBACHU,OAAA,EAAS,SAATA,QAAUC,GAAA,EAAQ;oBAChBL,OAAA,CAAQK,GAAG;kBACZ;kBACDC,IAAA,EAAM,SAANA,KAAOC,GAAA,EAAQ;oBACbN,MAAA,CAAOM,GAAG;kBACX;gBAAA,GACF;cACH,CAAC;YAAA;cAAAX,SAAA,CAAA5B,IAAA;cAAA,OAGKC,SAAA,CAAQC,QAAA,CAACsC,QAAA,CAAShB,MAAA,CAAKlD,KAAA,CAAM8C,EAAE;YAAA;cAErCnC,aAAA,CAAAC,KAAA,CAAIoB,SAAA,CAAU;gBACZC,KAAA,EAAO;gBACPC,IAAA,EAAM;cACR,CAAC;cAAAoB,SAAA,CAAA5B,IAAA;cAAA,OAGKyC,OAAA,CAAQC,SAAA,CAAUlB,MAAA,CAAK9C,MAAM;YAAA;cAGnC2C,UAAA,CAAW,YAAM;gBACfpC,aAAA,CAAAC,KAAA,CAAIyD,UAAA,CAAW;kBACbC,GAAA,EAAK;gBACP,CAAC;cACF,GAAE,IAAI;cAAAhB,SAAA,CAAA5B,IAAA;cAAA;YAAA;cAAA4B,SAAA,CAAA7B,IAAA;cAAA6B,SAAA,CAAAvB,EAAA,GAAAuB,SAAA;cAEP3C,aAAA,CAAAC,KAAA,CAAAC,KAAA,gDAAc,SAAAyC,SAAA,CAAAvB,EAAA,CAAc;cAC5BpB,aAAA,CAAAC,KAAA,CAAIoB,SAAA,CAAU;gBACZC,KAAA,EAAOqB,SAAA,CAAAvB,EAAA,CAAMwC,OAAA,IAAW;gBACxBrC,IAAA,EAAM;cACR,CAAC;YAAA;cAAAoB,SAAA,CAAA7B,IAAA;cAEDyB,MAAA,CAAK/C,QAAA,GAAW;cAAA,OAAAmD,SAAA,CAAAnB,MAAA;YAAA;YAAA;cAAA,OAAAmB,SAAA,CAAAlB,IAAA;UAAA;QAAA,GAAAe,QAAA;MAAA;IAEnB;EACF;AACH;;;;;;;;;;;;;;;;;;;;ACxJAqB,EAAA,CAAGC,UAAA,CAAWC,eAAe","ignoreList":[]}